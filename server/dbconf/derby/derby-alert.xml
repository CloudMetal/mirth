<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'conf/dtd/mybatis-3-mapper.dtd'>

<mapper namespace="Alert">
	<resultMap type="com.mirth.connect.model.Alert" id="get-alert-result">
		<result property="id" column="ID" />
		<result property="name" column="NAME" />
		<result property="enabled" column="IS_ENABLED" />		
		<result property="expression" column="EXPRESSION" />
		<result property="template" column="TEMPLATE" />
		<result property="subject" column="SUBJECT" />
	</resultMap>
	
	<select id="getAlert" parameterType="com.mirth.connect.model.Alert" resultMap="get-alert-result">
		SELECT A.ID, A.NAME, A.IS_ENABLED, A.EXPRESSION, A.TEMPLATE, A.SUBJECT
		FROM ALERT A
		<where>
         	<if test='id != null'>A.ID = #{id}</if>
      	</where>
	</select>

	<select id="getAlertByChannelId" parameterType="java.lang.String" resultMap="get-alert-result">
		SELECT A.ID, A.NAME, A.IS_ENABLED, A.EXPRESSION, A.TEMPLATE, A.SUBJECT
		FROM ALERT A, CHANNEL_ALERT CA
		WHERE A.ID = CA.ALERT_ID AND CA.CHANNEL_ID = #{id}
	</select>
	
	<select id="getChannelIdsByAlertId" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT CA.CHANNEL_ID
		FROM CHANNEL_ALERT CA
		WHERE CA.ALERT_ID = #{id}
	</select>
	
	<select id="getEmailsByAlertId" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT AE.EMAIL
		FROM ALERT_EMAIL AE
		WHERE AE.ALERT_ID = #{id}
	</select>
	
	<insert id="insertAlert" parameterType="com.mirth.connect.model.Alert">
		INSERT INTO ALERT (ID, NAME, IS_ENABLED, EXPRESSION, TEMPLATE, SUBJECT)
		VALUES (#{id}, #{name}, #{enabled}, #{expression}, #{template}, #{subject})
	</insert>

	<insert id="insertChannelAlert" parameterType="java.util.Map">
		INSERT INTO CHANNEL_ALERT (CHANNEL_ID, ALERT_ID)
		VALUES (#{channelId}, #{alertId})
	</insert>

	<insert id="insertAlertEmail" parameterType="java.util.Map">
		INSERT INTO ALERT_EMAIL (ALERT_ID, EMAIL)
		VALUES (#{alertId}, #{email})
	</insert>
	
	<delete id="deleteAlert" parameterType="com.mirth.connect.model.Alert">
		DELETE FROM ALERT
		<where>
         	<if test='id != null'>ID=#{id}</if>
      	</where>
	</delete>
	
	<select id="vacuumAlertTable" statementType="CALLABLE">
		{call SYSCS_UTIL.SYSCS_COMPRESS_TABLE('APP', 'ALERT', 0)}
	</select>
	
</mapper>