<project name="upgrade" basedir=".">
	<taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="lib/ant-contrib-0.6.jar" />
	<taskdef classpath="lib/orangevolt-ant-tasks-1.3.5.jar:lib/roxes-win32forjava-1.0.4.jar" resource="com/orangevolt/tools/ant/taskdefs.properties" />

	<target name="cleanOldInstaller">
		<echo>clearing registry settings</echo>
		<win32.registry root="HKEY_LOCAL_MACHINE" key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Mirth">
			<delete />
		</win32.registry>

		<win32.registry root="HKEY_LOCAL_MACHINE" key="SOFTWARE\Mirth">
			<delete />
		</win32.registry>
		
		<property environment="env"/>
		<echo>removing ${env.HOMEPATH}\Start Menu\Programs\Mirth</echo>
		<delete dir="${env.HOMEPATH}\Start Menu\Programs\Mirth" failonerror="false" />
	</target>

	<target name="backup">
		<available property="do.upgrade" value="true" file="${install.path}/conf/mirth.properties" />
		<if>
			<equals arg1="${do.upgrade}" arg2="true" />
			<then>
				<echo>performing backup of configuration properties</echo>
				<propertyfile file="${install.path}/conf/install.tmp.properties">
					<entry key="do.upgrade" value="${do.upgrade}" />
				</propertyfile>
				<property file="${install.path}/conf/mirth.properties" />
				<echo>database: ${database}</echo>
				<if>
					<equals arg1="${database}" arg2="derby" />
					<then />
					<else>
						<property file="${install.path}/conf/${database}-SqlMapConfig.properties" />
						<propertyfile file="${install.path}/conf/database.tmp.properties">
							<entry key="database.tmp" value="${database}" />
							<entry key="url.tmp" value="${url}" />
							<entry key="username.tmp" value="${username}" />
							<entry key="password.tmp" value="${password}" />
						</propertyfile>
					</else>
				</if>
			</then>
		</if>
	</target>

	<target name="restore">
		<property file="${install.path}/conf/install.tmp.properties" />
		<if>
			<equals arg1="${do.upgrade}" arg2="true" />
			<then>
				<echo>performing restore of configuration properties</echo>
				<property file="${install.path}/conf/database.tmp.properties" />
				<propertyfile file="${install.path}/conf/mirth.properties">
					<entry key="database" value="${database.tmp}" />
				</propertyfile>
				<propertyfile file="${install.path}/conf/${database.tmp}-SqlMapConfig.properties">
					<entry key="database" value="${database.tmp}" />
					<entry key="url" value="${url.tmp}" />
					<entry key="username" value="${username.tmp}" />
					<entry key="password" value="${password.tmp}" />
				</propertyfile>
			</then>
		</if>
	</target>

	<target name="finalize">
		<chmod file="${install.path}/mirth.sh" perm="+x" />
	</target>

	<target name="startManager">
		<exec executable="cmd" dir="${install.path}" spawn="true">
			<arg value="/c" />
			<arg value="Mirth Manager.exe" />
		</exec>
	</target>
</project>