<project>
	<shortName>mirth</shortName>
	<fullName>Mirth</fullName>
	<version>1.7.1</version>
	<leftImage>../installer/sidebar.png</leftImage>
	<enableRollback>1</enableRollback>
	<outputDirectory>../dist</outputDirectory>
	<allowComponentSelection>1</allowComponentSelection>

	<componentList>
		<component>
			<name>core</name>
			<description>Core Libraries</description>
			<canBeEdited>0</canBeEdited>
			<selected>1</selected>
			<show>1</show>
			<folderList>
				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>programfiles</name>
					<platforms>all</platforms>

					<distributionFileList>
						<distributionFile>
							<origin>../setup/mirth-server.jar</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/mirth-client-core.jar</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/mirth-launcher.jar</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/mirth-launcher.xml</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/keystore</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/activation.jnlp</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/mirth-client.jnlp</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/README.txt</origin>
						</distributionFile>

						<distributionDirectory>
							<origin>../setup/lib</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/client-lib</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/extensions</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/licenses</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/logs</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/mirthdb</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/public_html</origin>
						</distributionDirectory>
					</distributionFileList>

					<shortcutList>
						<shortcut>
							<comment>Uninstall</comment>
							<exec>${installdir}/${uninstallerName}</exec>
							<icon></icon>
							<name>Uninstall ${product_fullname}</name>
							<path>${installdir}</path>
							<platforms>all</platforms>
							<runInTerminal>0</runInTerminal>
							<windowsExec>${installdir}/${uninstallerName}.exe</windowsExec>
							<windowsExecArgs></windowsExecArgs>
							<windowsIcon></windowsIcon>
							<windowsPath>${installdir}</windowsPath>
						</shortcut>
					</shortcutList>

				</folder>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>programfileslinux</name>
					<platforms>linux, osx</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>mirth.sh</origin>
						</distributionFile>
					</distributionFileList>
					<actionList>
						<changePermissions>
							<files>mirth.sh</files>
							<permissions>755</permissions>
						</changePermissions>
					</actionList>
				</folder>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>programfileswindows</name>
					<platforms>windows</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/Mirth.bat</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/Mirth.exe</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/Mirth.ico</origin>
						</distributionFile>
					</distributionFileList>
				</folder>
			</folderList>

			<startMenuShortcutList>
				<startMenuShortcut>
					<comment>Start the Mirth server</comment>
					<name>Mirth Server</name>
					<runInTerminal>0</runInTerminal>
					<windowsExec>${installdir}/Mirth.exe</windowsExec>
					<windowsExecArgs></windowsExecArgs>
					<windowsIcon>${installdir}/Mirth.ico</windowsIcon>
					<windowsPath>${installdir}</windowsPath>
				</startMenuShortcut>
				<startMenuLinkShortcut>
					<comment>Start the Mirth administrator</comment>
					<name>Mirth Administrator</name>
					<runInTerminal>0</runInTerminal>
					<url>http://localhost:8080/webstart</url>
					<windowsIcon>${installdir}/Mirth.ico</windowsIcon>
				</startMenuLinkShortcut>
				<startMenuShortcut>
					<comment>Uninstall ${product_fullname}</comment>
					<name>Uninstall ${product_fullname}</name>
					<runInTerminal>0</runInTerminal>
					<windowsExec>${installdir}/${uninstallerName}.exe</windowsExec>
					<windowsExecArgs></windowsExecArgs>
					<windowsIcon></windowsIcon>
					<windowsPath>${installdir}/</windowsPath>
				</startMenuShortcut>
			</startMenuShortcutList>
		</component>

		<component>
			<name>configuration</name>
			<description>Configuration and database files</description>
			<canBeEdited>0</canBeEdited>
			<selected>1</selected>
			<show>1</show>
			<folderList>
				<folder>
					<description>Program Files</description>
					<destination>${installdir}/conf</destination>
					<name>properties</name>
					<platforms>all</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/conf/mirth.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/log4j.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/version.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/derby-SqlMapConfig.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/mysql-SqlMapConfig.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/oracle-SqlMapConfig.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/postgres-SqlMapConfig.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/sqlserver2005-SqlMapConfig.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/sqlserver-SqlMapConfig.properties</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/mule-template.xml</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/sql-map-2.dtd</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/conf/sql-map-config-2.dtd</origin>
						</distributionFile>
						<distributionDirectory>
							<origin>../setup/conf/deltas</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/conf/derby</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/conf/postgres</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/conf/mysql</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/conf/oracle</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/conf/sqlserver</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>../setup/conf/sqlserver2005</origin>
						</distributionDirectory>
					</distributionFileList>
				</folder>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}/conf/custom</destination>
					<name>custom</name>
					<platforms>all</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/conf/custom/dbdrivers.xml</origin>
						</distributionFile>
					</distributionFileList>
				</folder>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>scripts</name>
					<platforms>all</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/derby-database.sql</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/postgres-database.sql</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/mysql-database.sql</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/oracle-database.sql</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/sqlserver-database.sql</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/sqlserver2005-database.sql</origin>
						</distributionFile>
					</distributionFileList>
				</folder>
			</folderList>
		</component>

		<component>
			<name>shell</name>
			<description>Administrator Shell</description>
			<canBeEdited>1</canBeEdited>
			<selected>1</selected>
			<show>1</show>
			<folderList>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>programfiles</name>
					<platforms>all</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/shell.jar</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/shell-launcher.jar</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/shell-launcher.xml</origin>
						</distributionFile>
					</distributionFileList>
				</folder>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>programfileswindows</name>
					<platforms>windows</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/Shell.bat</origin>
						</distributionFile>
					</distributionFileList>
				</folder>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>programfileslinux</name>
					<platforms>linux, osx</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/shell.sh</origin>
						</distributionFile>
					</distributionFileList>
				</folder>
			</folderList>

			<startMenuShortcutList>
				<startMenuShortcut>
					<comment>Start the Mirth adminstrator shell</comment>
					<name>Mirth Shell</name>
					<runInTerminal>0</runInTerminal>
					<windowsExec>${installdir}/Shell.bat</windowsExec>
					<windowsExecArgs></windowsExecArgs>
					<windowsIcon>${installdir}/Mirth.ico</windowsIcon>
					<windowsPath>${installdir}</windowsPath>
				</startMenuShortcut>
			</startMenuShortcutList>
		</component>

		<component>
			<name>service</name>
			<description>Windows NT/XP/2003/Vista Service</description>
			<canBeEdited>1</canBeEdited>
			<selected>1</selected>
			<show>1</show>
			<folderList>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>wrapper</name>
					<platforms>windows</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/wrapper.exe</origin>
						</distributionFile>
					</distributionFileList>
				</folder>

				<folder>
					<description>Program Files</description>
					<destination>${installdir}/conf</destination>
					<name>wrapperconfiguration</name>
					<platforms>windows</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/conf/wrapper.conf</origin>
						</distributionFile>
					</distributionFileList>

					<actionList>
						<logMessage>
							<text>Creating Mirth service</text>
						</logMessage>

						<createWindowsService>
							<program>${installdir}/wrapper.exe</program>
							<programArguments>-s "${installdir}/conf/wrapper.conf"</programArguments>

							<serviceName>Mirth</serviceName>
							<displayName>Mirth Server</displayName>
							<description>Open source cross-platform health care integration engine</description>
							<startType>auto</startType>
						</createWindowsService>

						<logMessage>
							<text>Starting Mirth service</text>
						</logMessage>

						<startWindowsService>
							<serviceName>Mirth</serviceName>
						</startWindowsService>
					</actionList>
				</folder>

			</folderList>
		</component>

		<component>
			<name>manager</name>
			<description>Server Manager</description>
			<canBeEdited>1</canBeEdited>
			<selected>1</selected>
			<show>1</show>
			<folderList>
				<folder>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<name>programfileswindows</name>
					<platforms>windows</platforms>
					<distributionFileList>
						<distributionFile>
							<origin>../setup/MirthServerManager.exe</origin>
						</distributionFile>
						<distributionFile>
							<origin>../setup/mirth-manager.jar</origin>
						</distributionFile>
					</distributionFileList>

					<actionList>
						<logMessage>
							<text>Starting Mirth Server Manager</text>
						</logMessage>
						<runProgram>
							<program>${installdir}/MirthServerManager.exe</program>
							<programArguments></programArguments>
						</runProgram>
					</actionList>
				</folder>
			</folderList>

			<startMenuShortcutList>
				<startMenuShortcut>
					<comment>Start the Mirth server manager</comment>
					<name>Mirth Server Manager</name>
					<runInTerminal>0</runInTerminal>
					<windowsExec>${installdir}/MirthServerManager.exe</windowsExec>
					<windowsExecArgs></windowsExecArgs>
					<windowsIcon>${installdir}/Mirth.ico</windowsIcon>
					<windowsPath>${installdir}</windowsPath>
				</startMenuShortcut>
			</startMenuShortcutList>
		</component>
	</componentList>

	<parameterList>
		<directoryParameter>
			<name>installdir</name>
			<description>Installer.Parameter.installdir.description</description>
			<explanation>Installer.Parameter.installdir.explanation</explanation>
			<value>${platform_install_prefix}/${product_fullname}</value>
			<default>${platform_install_prefix}/${product_fullname}</default>
			<allowEmptyValue>0</allowEmptyValue>
			<ask>yes</ask>
			<cliOptionName>prefix</cliOptionName>
			<mustBeWritable>yes</mustBeWritable>
			<mustExist>0</mustExist>
			<width>40</width>
		</directoryParameter>
	</parameterList>

	<readyToInstallActionList>
		<logMessage>
			<text>Stopping Mirth service</text>
		</logMessage>

		<stopWindowsService>
			<ruleEvaluationLogic>and</ruleEvaluationLogic>
			<ruleList>
				<windowsServiceTest>
					<service>Mirth</service>
					<condition>exists</condition>
				</windowsServiceTest>
				<windowsServiceTest>
					<service>Mirth</service>
					<condition>is_running</condition>
				</windowsServiceTest>
			</ruleList>
			<serviceName>Mirth</serviceName>
			<abortOnError>0</abortOnError>
			<showMessageOnError>0</showMessageOnError>
		</stopWindowsService>

		<logMessage>
			<text>Killing Mirth Server Manager</text>
		</logMessage>

		<kill>
			<ruleList>
				<platformTest>
					<type>windows</type>
				</platformTest>
			</ruleList>
			<name>MirthServerManager.exe</name>
			<abortOnError>0</abortOnError>
			<showMessageOnError>0</showMessageOnError>
		</kill>

		<logMessage>
			<text>Backing up properties</text>
		</logMessage>

		<!-- find the database currently being used -->
		<propertiesFileGet>
			<ruleList>
				<fileTest>
					<path>${installdir}/conf/mirth.properties</path>
					<condition>exists</condition>
				</fileTest>
			</ruleList>

			<file>${installdir}/conf/mirth.properties</file>
			<variable>database.temp</variable>
			<key>database</key>
		</propertiesFileGet>

		<!-- backup the database properties -->
		<propertiesFileGet>
			<ruleEvaluationLogic>and</ruleEvaluationLogic>
			<ruleList>
				<compareText>
					<text>${database}</text>
					<logic>does_not_equal</logic>
					<value>derby</value>
				</compareText>
				<fileTest>
					<path>${installdir}/conf/${database.temp}-SqlMapConfig.properties</path>
					<condition>exists</condition>
				</fileTest>
			</ruleList>

			<file>${installdir}/conf/${database.temp}-SqlMapConfig.properties</file>
			<variable>url.temp</variable>
			<key>url</key>
		</propertiesFileGet>

		<propertiesFileGet>
			<ruleEvaluationLogic>and</ruleEvaluationLogic>
			<ruleList>
				<compareText>
					<text>${database}</text>
					<logic>does_not_equal</logic>
					<value>derby</value>
				</compareText>
				<fileTest>
					<path>${installdir}/conf/${database.temp}-SqlMapConfig.properties</path>
					<condition>exists</condition>
				</fileTest>
			</ruleList>

			<file>${installdir}/conf/${database.temp}-SqlMapConfig.properties</file>
			<variable>username.temp</variable>
			<key>username</key>
		</propertiesFileGet>

		<propertiesFileGet>
			<ruleEvaluationLogic>and</ruleEvaluationLogic>
			<ruleList>
				<compareText>
					<text>${database}</text>
					<logic>does_not_equal</logic>
					<value>derby</value>
				</compareText>
				<fileTest>
					<path>${installdir}/conf/${database.temp}-SqlMapConfig.properties</path>
					<condition>exists</condition>
				</fileTest>
			</ruleList>

			<file>${installdir}/conf/${database.temp}-SqlMapConfig.properties</file>
			<variable>password.temp</variable>
			<key>password</key>
		</propertiesFileGet>

		<!-- backup mirth properties -->
		<propertiesFileGet>
			<ruleList>
				<fileTest>
					<path>${installdir}/conf/mirth.properties</path>
					<condition>exists</condition>
				</fileTest>
			</ruleList>

			<file>${installdir}/conf/mirth.properties</file>
			<variable>http.port.temp</variable>
			<key>http.port</key>
		</propertiesFileGet>

		<propertiesFileGet>
			<ruleList>
				<fileTest>
					<path>${installdir}/conf/mirth.properties</path>
					<condition>exists</condition>
				</fileTest>
			</ruleList>

			<file>${installdir}/conf/mirth.properties</file>
			<variable>https.port.temp</variable>
			<key>https.port</key>
		</propertiesFileGet>

		<propertiesFileGet>
			<ruleList>
				<fileTest>
					<path>${installdir}/conf/mirth.properties</path>
					<condition>exists</condition>
				</fileTest>
			</ruleList>

			<file>${installdir}/conf/mirth.properties</file>
			<variable>jmx.port.temp</variable>
			<key>jmx.port</key>
		</propertiesFileGet>

		<logMessage>
			<text>
				Database properties: database = ${database.temp}, url = ${url.temp}, username = ${username.temp}, password = ${password.temp}
			</text>
		</logMessage>

		<logMessage>
			<text>Mirth Properties: http.port = ${http.port}, https.port = ${htts.port}, jmx.port = ${jmx.port}</text>
		</logMessage>
	</readyToInstallActionList>

	<postInstallationActionList>
		<logMessage>
			<text>Restoring properties</text>
		</logMessage>

		<!-- restore database type -->
		<propertiesFileSet>
			<file>${installdir}/conf/mirth.properties</file>
			<key>database</key>
			<value>${database.temp}</value>
		</propertiesFileSet>

		<!-- restore database properties -->
		<propertiesFileSet>
			<file>${installdir}/conf/${database.temp}-SqlMapConfig.properties</file>
			<key>url</key>
			<value>${url.temp}</value>
		</propertiesFileSet>
		<propertiesFileSet>
			<file>${installdir}/conf/${database.temp}-SqlMapConfig.properties</file>
			<key>username</key>
			<value>${username.temp}</value>
		</propertiesFileSet>
		<propertiesFileSet>
			<file>${installdir}/conf/${database.temp}-SqlMapConfig.properties</file>
			<key>password</key>
			<value>${password.temp}</value>
		</propertiesFileSet>

		<!-- restore mirth properties -->
		<propertiesFileSet>
			<file>${installdir}/conf/mirth.properties</file>
			<key>http.port</key>
			<value>${http.port.temp}</value>
		</propertiesFileSet>
		<propertiesFileSet>
			<file>${installdir}/conf/mirth.properties</file>
			<key>https.port</key>
			<value>${https.port.temp}</value>
		</propertiesFileSet>
		<propertiesFileSet>
			<file>${installdir}/conf/mirth.properties</file>
			<key>jmx.port</key>
			<value>${jmx.port.temp}</value>
		</propertiesFileSet>
	</postInstallationActionList>

	<preUninstallationActionList>
		<logMessage>
			<text>Stopping Mirth service</text>
		</logMessage>

		<stopWindowsService>
			<ruleEvaluationLogic>and</ruleEvaluationLogic>
			<ruleList>
				<windowsServiceTest>
					<service>Mirth</service>
					<condition>exists</condition>
				</windowsServiceTest>
				<windowsServiceTest>
					<service>Mirth</service>
					<condition>is_running</condition>
				</windowsServiceTest>
			</ruleList>

			<serviceName>Mirth</serviceName>
			<abortOnError>0</abortOnError>
			<showMessageOnError>0</showMessageOnError>
		</stopWindowsService>

		<logMessage>
			<text>Deleting Mirth service</text>
		</logMessage>

		<deleteWindowsService>
			<ruleList>
				<windowsServiceTest>
					<service>Mirth</service>
					<condition>exists</condition>
				</windowsServiceTest>
			</ruleList>

			<serviceName>Mirth</serviceName>
			<abortOnError>0</abortOnError>
			<showMessageOnError>0</showMessageOnError>
		</deleteWindowsService>

		<logMessage>
			<text>Killing Mirth</text>
		</logMessage>

		<kill>
			<ruleList>
				<platformTest>
					<type>windows</type>
				</platformTest>
			</ruleList>
			<name>Mirth.exe</name>
			<abortOnError>0</abortOnError>
			<showMessageOnError>0</showMessageOnError>
		</kill>

		<logMessage>
			<text>Killing Mirth Server Manager</text>
		</logMessage>

		<kill>
			<ruleList>
				<platformTest>
					<type>windows</type>
				</platformTest>
			</ruleList>
			<name>MirthServerManager.exe</name>
			<abortOnError>0</abortOnError>
			<showMessageOnError>0</showMessageOnError>
		</kill>
	</preUninstallationActionList>
</project>