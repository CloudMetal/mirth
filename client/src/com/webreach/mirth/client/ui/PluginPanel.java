/*
 * PluginPanel.java
 *
 * Created on June 25, 2007, 11:36 AM
 */

package com.webreach.mirth.client.ui;

import java.awt.Color;
import java.util.HashMap;
import java.util.Map;

import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTabbedPane;
import javax.swing.border.LineBorder;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;

import com.webreach.mirth.client.core.ClientException;
import com.webreach.mirth.model.PluginMetaData;
import com.webreach.mirth.plugins.ClientPlugin;

/**
 *
 * @author  brendanh
 */
public class PluginPanel extends javax.swing.JPanel
{
    Frame parent;
    Map<String, ClientPlugin> loadedPlugins;
    
    /** Creates new form PluginPanel */
    public PluginPanel()
    {
        parent = PlatformUI.MIRTH_FRAME;
        initComponents();
        loadPlugins();
        
        ChangeListener changeListener = new ChangeListener()
        {
            public void stateChanged(ChangeEvent changeEvent)
            {
                JTabbedPane sourceTabbedPane = (JTabbedPane) changeEvent.getSource();
                int index = sourceTabbedPane.getSelectedIndex();
                loadPlugin(sourceTabbedPane.getTitleAt(index));
            }
        };
        tabs.addChangeListener(changeListener);
    }
    
    public void loadPlugins()
    {
        loadedPlugins = new HashMap<String,ClientPlugin>();
        
        try
        {
            Map<String, PluginMetaData> plugins = parent.mirthClient.getPluginMetaData();
            for (PluginMetaData metaData : plugins.values())
            {
                try
                {
                    String pluginName = metaData.getName();
                    ClientPlugin plugin = (ClientPlugin) Class.forName(metaData.getClientClassName()).getDeclaredConstructors()[0].newInstance(new Object[]{pluginName});
                    
                    plugin.start();
                    
                    // add task pane before the "other" pane
                    if(plugin.getTaskPane() != null)
                    {
                        parent.setNonFocusable(plugin.getTaskPane());
                        plugin.getTaskPane().setVisible(false);
                        parent.taskPaneContainer.add(plugin.getTaskPane(), parent.taskPaneContainer.getComponentCount()-1);
                    }
                    
                    if (plugin.getComponent() != null)
                        tabs.addTab(pluginName, plugin.getComponent());
                    
                    loadedPlugins.put(pluginName, plugin);
                }
                catch (Exception e)
                {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
            }
        }
        catch (ClientException ex)
        {
            ex.printStackTrace();
        }
    }
    
    public void stopPlugins()
    {
        for(ClientPlugin plugin : loadedPlugins.values())
            plugin.stop();
    }
    
    public void loadDefaultPanel()
    {
        if(tabs.getComponentCount() > 0)
            loadPlugin(loadedPlugins.keySet().iterator().next());
        else
            setBlankPanel();
    }

    public void loadPlugin(String pluginName)
    {
        ClientPlugin plugin = loadedPlugins.get(pluginName);
        if(plugin != null)
        {
            parent.setFocus(plugin.getTaskPane());
            plugin.display();
        }
        else
            parent.setFocus(null);
    }
    
    public void setBlankPanel()
    {
        JPanel panel = new JPanel();
        panel.add(new JLabel("No plugin panels to display."));
        panel.setBackground(Color.WHITE);
        tabs.addTab("No Plugins", panel);
        tabs.setSelectedIndex(0);
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">//GEN-BEGIN:initComponents
    private void initComponents()
    {
        tabs = new javax.swing.JTabbedPane();

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(tabs, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 400, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(tabs, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 300, Short.MAX_VALUE)
        );
    }// </editor-fold>//GEN-END:initComponents
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTabbedPane tabs;
    // End of variables declaration//GEN-END:variables
    
}
