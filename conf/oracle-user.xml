<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"conf/sql-map-2.dtd">

<sqlMap namespace="User">
	<resultMap class="com.webreach.mirth.model.User" id="get-user-result">
		<result property="id" column="ID" jdbcType="INTEGER" />
		<result property="username" column="USERNAME" />
		<result property="fullName" column="FULLNAME" />
		<result property="email" column="EMAIL" />
		<result property="phoneNumber" column="PHONENUMBER" />
		<result property="description" column="DESCRIPTION" />
	</resultMap>

	<select id="getUser" parameterClass="com.webreach.mirth.model.User" resultMap="get-user-result">
		SELECT ID, USERNAME, FULLNAME, EMAIL, PHONENUMBER, DESCRIPTION
		FROM PERSON
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="id">
				ID = #id#
			</isNotNull>
			<isNotNull prepend="AND" property="username">
				USERNAME = #username#
			</isNotNull>
		</dynamic>
	</select>

	<select id="getUserPassword" parameterClass="com.webreach.mirth.model.User" resultClass="java.lang.String">
		SELECT PASSWORD
		FROM PERSON
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="username">
				USERNAME = #username#
			</isNotNull>
		</dynamic>
	</select>
	
	<insert id="insertUser" parameterClass="java.util.Map">
		INSERT INTO
		PERSON (ID, USERNAME, PASSWORD, FULLNAME, EMAIL, PHONENUMBER, DESCRIPTION, LOGGED_IN)
		VALUES (PERSON_SEQUENCE.NEXTVAL, #username#, #password#, #fullName:VARCHAR#, #email:VARCHAR#, #phoneNumber:VARCHAR#, #description:VARCHAR#, 0)
	</insert>
	
	<update id="updateUser" parameterClass="java.util.Map">
		UPDATE PERSON
		SET USERNAME = #username#,
			PASSWORD = #password#,
			FULLNAME = #fullName:VARCHAR#,
			EMAIL = #email:VARCHAR#,
			PHONENUMBER = #phoneNumber:VARCHAR#,
			DESCRIPTION = #description:VARCHAR#
		WHERE ID = #id#
	</update>
	
	<delete id="deleteUser" parameterClass="com.webreach.mirth.model.User">
		DELETE FROM PERSON
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="id">
				ID=#id#
			</isNotNull>
		</dynamic>
	</delete>

	<!-- Login/Logout Procedures -->

	<update id="loginUser" parameterClass="java.lang.String">
		UPDATE PERSON
		SET LOGGED_IN = 1
		WHERE ID = #id#
	</update>

	<update id="logoutUser" parameterClass="java.lang.String">
		UPDATE PERSON
		SET LOGGED_IN = 0
		WHERE ID = #id#
	</update>

	<select id="isUserLoggedIn" parameterClass="java.lang.String" resultClass="java.lang.Boolean">
		SELECT LOGGED_IN
		FROM PERSON
		WHERE ID = #id#
	</select>
	
	<update id="resetUserStatus">
		UPDATE PERSON
		SET LOGGED_IN = 0
	</update>	
</sqlMap>